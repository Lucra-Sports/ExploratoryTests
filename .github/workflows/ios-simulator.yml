name: test on iOS simulator

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build and Test default scheme using any available iPhone simulator
    runs-on: macos-latest

    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'
      - name: Checkout
        uses: actions/checkout@v3
      - name: Test
        uses: sersoft-gmbh/xcodebuild-action@v1
        with:
          action: test
          result-bundle-path: test-results/all-tests
          project: Experiments.xcodeproj
          scheme: Experiments
          destination: platform=iOS Simulator,OS=15.2,name=iPhone 13 Pro
      - name: Remove symbolic link created by Xcode
        if: always()
        run: rm test-results/all-tests || true
      - name: Archive results # due to: https://github.com/actions/upload-artifact/issues/243
        if: always()
        run: zip -FSry results.zip test-results || true
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: results.zip
